---
output:
  pdf_document:
    fig_crop: no
    number_sections: yes
  html_document:
    df_print: paged
fontsize: 11pt
documentclass: article
geometry:
- a4paper
- textwidth=18cm
- textheight=21cm
header-includes:
- \usepackage[brazil, english, portuguese]{babel}
- \usepackage[utf8]{inputenc}
- \usepackage[T1]{fontenc}
- \usepackage[fixlanguage]{babelbib}
- \usepackage{times}
- \usepackage{caption}
- \captionsetup[table]{skip=10pt}
- \usepackage{amsmath}
- \usepackage{subcaption}
---

```{=tex}
\begin{titlepage} 

\begin{center} 
{\large Universidade Estadual de Campinas}\\[0.2cm] 
{\large Mineração de Dados COmplexos - INF0612}\\[4cm]

{\bf \huge Trabalho Final}\\[4cm]

{\large Grupo}\\[0.2cm]
{\large Nicole Nogueira Silva}\\[0.2cm]
{\large Rodolfo Dalla Costa}\\[4cm]

{\large Campinas}\\[0.2cm]
{\large 2021}
\end{center}

\end{titlepage}
```
\tableofcontents

\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = F, message = F, fig.height = 3, fig.width = 4, fig.align='center')
library(knitr)
library(kableExtra)
library(magrittr)
library(tidyverse)
library(xtable)
```

\section{Introdução}

\quad O Centro de Pesquisas Meteorológicas e Climáticas Aplicadas à Agricultura (Cepagri) é um instituto de pesquisa que fornece informações meteorológicas da cidade de Campinas. Esse trabalho tem como objetivo extrair análises a partir dos dados provenientes do Cepagri e entender o compartamento do clima baseado nos indicadores climáticos medidos.

\section{Banco de dados}

```{r}
setwd("C:/Users/nicol/Documents/Mineração de dados/inf-0611-0612/inf0612/t-final")
data_source_path <- './cepagri.csv'
cepagri_data <- read.table(data_source_path, header=FALSE, sep=';', fill = TRUE)
names(cepagri_data) <- c("data", "temperatura", "vento", "umidade", "sensacao")

```

\quad O banco de dados utilizado para essa análise originou-se de consultas ao site do Cepagri (www.cepagri.unicamp.br) que a cada 10 minutos extraiu informações sobre a temperatura, velocidade do vento, umidade e sensação térmica. Na Tabela \ref{tab:dados} pode-se observar os 5 primeiros registros da base. Originalmente a base contém 387260 registros e 5 colunas.

```{r}

head(cepagri_data) %>% 
  kable("latex", col.names = c("Data", "Temperatura", "Vento", "Umidade", "Sensação Térmica"), caption = "\\label{tab:dados}Primeiras linhas do banco de dados", booktabs = T) %>% 
  kable_styling(latex_options = "hold_position", font_size = 8)

```

\subsection{Tratamento dos dados}

```{r}
# Removendo dados faltantes ou com erro
cepagri_data <- cepagri_data[!is.na(cepagri_data$sensacao), ]

# Analisando se os tipos estao adequadas
class(cepagri_data$data)
class(cepagri_data$temperatura)
class(cepagri_data$vento)
class(cepagri_data$umidade)
class(cepagri_data$sensacao)

# Convertendo para o tipo adequado
cepagri_data$temperatura <- as.numeric(cepagri_data$temperatura)

head(cepagri_data[cepagri_data$sensacao < 0, ], 10)

# Sumarizando as colunas para entender possiveis outliers
summary(cepagri_data)

# Checando e removendo os outliers
head(cepagri_data[cepagri_data$sensacao < 0, ], 10)
head(cepagri_data[cepagri_data$sensacao > 60, ], 10)

cepagri_data[cepagri_data$sensacao > 70, 5] <- NA



consecutive <- function(vector, k = 2) {
  n <- length(vector)
  result <- logical(n)
  
  for(i in k:n) {
    if(all(vector[(i-k+1):i] == vector[i])) {
      result[(i-k+1): i] <- TRUE
    }
  }
  
  return(result)
}

#sum(consecutive(cepagri_data$temperatura))
#sum(consecutive(cepagri_data$vento) & consecutive(cepagri_data$vento) & consecutive(cepagri_data$vento))
#sum(consecutive(cepagri_data$vento, 6) & consecutive(cepagri_data$vento, 6) & consecutive(cepagri_data$vento, 6))

#any(consecutive(cepagri_data$temp, 1440)) # 10 dias
#any(consecutive(cepagri_data$temp, 1584)) # 11 dias

cepagri_data[ , 1] <- as.POSIXct(cepagri_data[ , 1], format = '%d/%m/%Y-%H:%M',tz = "America/Sao_Paulo")

#filtro <- consecutive(cepagri_data$temperatura, 144)

cepagri_data$data <- as.POSIXlt(cepagri_data$data)
cepagri_data$ano <- unclass(cepagri_data$data)$year + 1900
cepagri_data$mes <- unclass(cepagri_data$data)$mon +1

temp_media_ano <- tapply(cepagri_data$temperatura, cepagri_data$ano, mean)

cepagri_data <- cepagri_data[cepagri_data$ano > 2014,]
cepagri_data <- cepagri_data[cepagri_data$ano < 2021,]
```

\quad O tratamento dos dados foi realizado levando em consideração as orientações passadas em aula. Primeiramente foi necessario garantir que o comando de leitura do arquivo CSV fosse capaz de lidar com dados inesperados, como a palavra ERRO e a falta de colunas em algumas linhas. Para isso foi utilizado o argumento fill como TRUE da funcao read.table().

Apos isso, todos os dados que continham NA na coluna Sensacao, resultado da conversao das linhas com valores inadequados, foram removidos.

Logo em seguida, foi checado as classes de todas as colunas, constatou-se que a coluna temperatura estava com o tipo char, e deveria ser um tipo numerico, portanto foi realizada a conversao do tipo desta coluna para numerico, para garantir a integridade dos dados no dataframe.

Depois disso, foi realizada a etapa de remocao de outliers. Primeiro foi avaliado com summary a estatistica do dataframe, com isso constatou-se que a sensacao termina possuia valores fora do esperado, como 99, para garantir uma integridade adequada do dataframe, foram removidos todas as linhas com sensacao acima de 60, como os unicos valores fora da variacao esperada eram 99, apenas as linhas com esse valor na coluna sensacao, foram removidas

Apos essa etapa, foi entao realizada a checagem de repeticao de dados, para isso foi utilizado uma estrategia de checagem de repeticao de linhas numa variacao especifica, por exemplo, para checar se ha repeticao de dados num prazo de 10, nesse caso, a funcao percorre o dataframe observando se o elemento atual é igual aos 1440 elementos apos ele. Percebeu-se que, em termos gerais, ha uma possivel repeticao de dados no equivalente a 10 dias.

Apos isso, percebeu-se entao que haviam dados alem dos que interessavem para a analise neste relatorio, desse modo, foi removido da base qualquer dado de anos menores que 2015 ou maiores que 2020.

Apos a fase inicial de analise e tratamento dos dados, o dataframe usado para o relatorio pode ser conferido na \ref{tab:dados2}, onde estao as 5 primeiras linhas da base ja tratada:

```{r}

head(cepagri_data) %>% 
  kable("latex", col.names = c("Data", "Temperatura", "Vento", "Umidade", "Sensação Térmica", "ano", "mes"), caption = "\\label{tab:dados2}Primeiras linhas do banco de dados tratado", booktabs = T) %>% 
  kable_styling(latex_options = "hold_position", font_size = 8)

```

\section{Análise exploratória}

\quad Na figura \ref{fig:graf1}

```{r, fig.cap="\\label{fig:graf1} Legenda", fig.pos='H', fig.width = 5}

cepagri_data_fac <- cepagri_data
cepagri_data_fac$mes <- factor(cepagri_data_fac$mes, labels = c("Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"))

cepagri_data_fac %>%
  filter(umidade > 0) %>%
  group_by(ano, mes) %>%
  summarise(temp_media = mean(temperatura), umidade_media = mean(umidade)) %>%
  ggplot(., aes(x = mes, y= temp_media,  fill = umidade_media))+
  geom_boxplot() 
```

```{r, fig.cap="\\label{fig:gra2} Legenda", fig.pos='H', fig.width = 6}

cepagri_data_fac %>%
  filter(umidade > 0) %>%
  group_by(ano, mes) %>%
  summarise(temp_media = mean(temperatura), umidade_media = mean(umidade)) %>%
  ggplot(., aes(x = mes, y= temp_media,  colour = umidade_media))+
  geom_point() 
```

```{r, fig.cap="\\label{fig:gra3} Legenda", fig.pos='H',  fig.width = 6}

cepagri_data %>%
  filter(umidade > 0) %>%
  group_by(ano, mes) %>%
  summarise(temp_media = mean(temperatura), umidade_media = mean(umidade)) %>%
  ggplot(., aes(x = temp_media, y= umidade_media))+
  geom_line(aes(color = as.factor(ano))) 
```

```{r, fig.cap="\\label{fig:gra4} Legenda", fig.pos='H',  fig.width = 6}

t2020 <- cepagri_data[cepagri_data$ano == 2020,] %>% group_by(mes) %>% summarise(avg = mean(temperatura,na.rm = TRUE))
t2019 <- cepagri_data[cepagri_data$ano == 2019,] %>% group_by(mes) %>% summarise(avg = mean(temperatura,na.rm = TRUE))
t2018 <- cepagri_data[cepagri_data$ano == 2018,] %>% group_by(mes) %>% summarise(avg = mean(temperatura,na.rm = TRUE))
t2017 <- cepagri_data[cepagri_data$ano == 2017,] %>% group_by(mes) %>% summarise(avg = mean(temperatura,na.rm = TRUE))
t2016 <- cepagri_data[cepagri_data$ano == 2016,] %>% group_by(mes) %>% summarise(avg = mean(temperatura,na.rm = TRUE))
t2015 <- cepagri_data[cepagri_data$ano == 2015,] %>% group_by(mes) %>% summarise(avg = mean(temperatura,na.rm = TRUE))

t2015$ano <- rep(2015, nrow(t2015))
t2016$ano <- rep(2016, nrow(t2016))
t2017$ano <- rep(2017, nrow(t2017))
t2018$ano <- rep(2018, nrow(t2018))
t2019$ano <- rep(2019, nrow(t2019))
t2020$ano <- rep(2020, nrow(t2020))

t_media_allyears <- rbind(t2015, t2016, t2017, t2018, t2019, t2020)
correct_order <- c("Jan","Feb","Mar","Apr","May","Jun",
                   "Jul","Aug","Sep","Oct","Nov","Dec")

p <- ggplot(t_media_allyears , aes(x = mes , y = avg, color=as.factor(ano)))
p <- p + scale_x_discrete(limits=correct_order) + geom_point() +
  geom_line(data=t_media_allyears[t_media_allyears$ano == 2015,]) +
  geom_line(data=t_media_allyears[t_media_allyears$ano == 2016,]) +
  geom_line(data=t_media_allyears[t_media_allyears$ano == 2017,]) +
  geom_line(data=t_media_allyears[t_media_allyears$ano == 2018,]) +
  geom_line(data=t_media_allyears[t_media_allyears$ano == 2019,]) +
  geom_line(data=t_media_allyears[t_media_allyears$ano == 2020,])
print(p+ ggtitle("Media de temperaturas de 2015 a 2020"))
```

\quad Para o \ref{fig:gra4} foi necessário elaborar um dataset filtrado, que contem as medias de cada ano por mes, é possível ver o dataset na \ref{tab:temp_media_mes_ano}.
```{r}

t_media_allyears %>% 
  kable("latex", col.names = c("Mes", "Avg (Temperatura Media", "Ano"), caption = "\\label{tab:temp_media_mes_ano} Temperaturas medias por mes de cada ano", booktabs = T) %>% 
  kable_styling(latex_options = "hold_position", font_size = 8)

```
é possível observar as variacoes das temperaturas medias no decorrer dos meses nos anos de 2015 a 2020. É possivel notar que o ano de 2020 possui um padrao muito divergente com relacao aos outro anos. Em parte isso pode ser devido ao fato de haver menos dados de 2020 que dos outros anos como pode se ver \ref{tab:numero_linhas}:

```{r}
cbind(
n2020 = nrow(cepagri_data[cepagri_data$ano ==2020,]),
n2019 = nrow(cepagri_data[cepagri_data$ano ==2019,]),
n2018 = nrow(cepagri_data[cepagri_data$ano ==2018,]),
n2017 = nrow(cepagri_data[cepagri_data$ano ==2017,]),
n2016 = nrow(cepagri_data[cepagri_data$ano ==2016,]),
n2015 = nrow(cepagri_data[cepagri_data$ano ==2015,])
) %>% 
  kable("latex", col.names = c("2020", "2019", "2018", "2017", "2016", "2015"), caption = "\\label{tab:numero_linhas}Primeiras linhas do banco de dados", booktabs = T) %>% 
  kable_styling(latex_options = "hold_position", font_size = 8)

```

No entanto, apesar da falta de dados que pode ser observada, o ano de 2020 foi marcado por um numero de queimadas acima do comum para o periodo de estiagem, que contemplam os meses de julho e agosto, essa informcao pode ser conferida em diversos sites assim como [este](https://g1.globo.com/pa/para/noticia/2020/09/03/queimadas-aumentam-304percent-no-para-entre-julho-e-agosto-aponta-inpe.ghtml). A analise de repeticao ou duplicidade de dados tambem  nao indicou que haviam valores repetidos por mais que um dia.
```
any(consecutive(cepagri_data[cepagri_data$ano == 2020,]$temperatura, 144))
```
Desse modo, percebe-se que seria interessante poder cruzar os dados de queimadas na regiao de Campinas com outros dados metereologicos para identificar o perfil de influencia do aumento de queimadas no clima. Ha claramente outros fatores meteorologicos que podem influenciar nessa variacao constatada, assim como pode se tratar de erro do equipamento, ou falhas nas leituras que demoraram a ter correcao, porem, a analise dos dados de 2020 nao indica uma anormalidade relacionada aos instrumetos utilizados para a coleta da informacao, como é possivel obervsar abaixo:
```
summary(cepagri_data[cepagri_data$ano == 2020,]$temperatura)
summary(cepagri_data[cepagri_data$ano == 2019,]$temperatura)
summary(cepagri_data[cepagri_data$ano == 2018,]$temperatura)
summary(cepagri_data[cepagri_data$ano == 2017,]$temperatura)
summary(cepagri_data[cepagri_data$ano == 2016,]$temperatura)
summary(cepagri_data[cepagri_data$ano == 2015,]$temperatura)
```
A temperatura para todo o ano de 2020 apresenta uma media geral dentro do comum, porem, percebe-se que as menores temperaturas sao mais altas do quenos outros anos, o que indica que, de fato, o ano de 2020 registrou maiores temperaturas com maior frequencia e nao se trata de um erro tecnico.

\quad
Outra analise interessante de ser realizada é a análise da sensacao termica, dada a velocidade do vento e a temperatura
```{r, fig.cap="\\label{fig:gra5} Legenda", fig.pos='H',  fig.width = 6}

p <- ggplot(cepagri_data , aes(x = temperatura , y = vento, color=sensacao))
p <- p + geom_point() + geom_point()
p
```
Como pode ser observado no \ref{fig:gra5} nota-se quanto mais baixo a umidade e maior a temperatura, maior é a sensacao
```
#bplot <- ggplot(cepagri_data, aes(x=ano, y= temperatura, group=ano))
#bplot <- bplot + geom_boxplot()
#bplot
#
#bplot <- ggplot(cepagri_data, aes(x=ano, y=vento, group=ano))
#bplot <- bplot + geom_boxplot()
#bplot
#
#bplot <- ggplot(t_media_allyears, aes(x=ano, y= avg, group=ano))
#bplot <- bplot + geom_boxplot()
#bplot

```

\section{Conclusão}
